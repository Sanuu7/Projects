<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sanuu Flix</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* Basic Reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Roboto', sans-serif;
      background: #121212;
      color: #fff;
      transition: background 0.3s, color 0.3s;
    }
    body.light-mode { background: #fff; color: #333; }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.8);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      transition: filter 0.3s;
    }
    header.blur { filter: blur(5px); }
    .header-spacer { width: 48px; }
    h1 { font-size: 24px; display: flex; align-items: center; }
    .header-controls { display: flex; gap: 10px; align-items: center; }
    .theme-button {
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 5px;
    }
    .trakt-login-button {
      background: #ed1c24;
      border: none;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    select {
      padding: 5px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 5px;
    }
    body.light-mode select { background: #ddd; color: #333; }

    /* Search Backdrop */
    .search-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .search-backdrop.show { opacity: 1; }
    .floating-search {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1f1f1f;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }
    body.light-mode .floating-search { background: #f0f0f0; }
    .close-search {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    #search-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      background: #333;
      color: #fff;
    }
    body.light-mode #search-input { background: #ddd; color: #333; }
    .switcher {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 10px;
    }
    .switcher label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    .switcher input { margin-right: 5px; }
    #search-button {
      width: 100%;
      padding: 10px;
      background: #6200ea;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Main Content */
    main {
      padding: 80px 20px 20px;
      transition: filter 0.3s;
    }
    main.blur { filter: blur(5px); }
    .trending-section { margin-bottom: 40px; }
    .trending-section h2 {
      font-size: 20px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .sort-by {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    .card {
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .card:hover { transform: scale(1.05); }
    .card img {
      width: 100%;
      height: auto;
      border-radius: 5px;
    }
    .card-content {
      padding: 10px 0;
      text-align: center;
    }
    .card-content h3 { font-size: 14px; }
    .card-content p { font-size: 12px; color: #aaa; }
    .watchlist-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      color: #fff;
      padding: 5px;
      border-radius: 50%;
      cursor: pointer;
    }
    .card-tooltip {
      display: none;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      width: 200px;
      font-size: 12px;
      z-index: 10;
    }
    .card:hover .card-tooltip { display: block; }
    .see-more-container {
      text-align: center;
      margin-top: 20px;
    }
    .see-more-container button {
      background: #6200ea;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Embed Modal */
    #embed-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1002;
      justify-content: center;
      align-items: center;
    }
    #embed-content {
      position: relative;
      width: 90%;
      max-width: 800px;
      background: #1f1f1f;
      padding: 20px;
      border-radius: 10px;
    }
    body.light-mode #embed-content { background: #f0f0f0; }
    .close-button {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
    }
    .api-selector {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #embed-content iframe {
      width: 100%;
      height: 450px;
      border: none;
      border-radius: 5px;
    }
    .selectors {
      display: none;
      gap: 10px;
      margin: 10px 0;
    }
    .selectors select {
      flex: 1;
      padding: 5px;
    }
    #embed-content button {
      margin-top: 10px;
      padding: 10px;
      background: #6200ea;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .share-button { background: #0288d1; }
    .trailer-button { background: #d81b60; }
    .back-button { background: #388e3c; }
    .watched-button { background: #ed1c24; }

    /* Spinner */
    .spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 5px solid #f3f3f3;
      border-top: 5px solid #6200ea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

    /* Responsive Design */
    @media (max-width: 600px) {
      .results-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
      #embed-content iframe { height: 300px; }
      .header-controls { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-spacer"></div>
    <h1 id="app-title"><span class="material-icons">movie</span> Sanuu Flix</h1>
    <div class="header-controls">
      <button id="search-toggle" class="theme-button"><span class="material-icons">search</span></button>
      <button id="watchlist-toggle" class="theme-button"><span class="material-icons">bookmark</span></button>
      <button id="history-toggle" class="theme-button"><span class="material-icons">history</span></button>
      <select id="language-select">
        <option value="en-US">English</option>
        <option value="de-DE">German</option>
      </select>
      <button id="theme-toggle" class="theme-button"><span class="material-icons">brightness_6</span></button>
      <button id="trakt-login" class="trakt-login-button"><span class="material-icons">login</span></button>
    </div>
  </header>

  <div id="search-backdrop" class="search-backdrop">
    <div id="floating-search" class="floating-search">
      <span class="material-icons close-search">close</span>
      <input type="text" id="search-input" placeholder="Search for movies or series...">
      <div class="switcher">
        <label for="search-movie">
          <input type="radio" name="search-type" value="movie" id="search-movie" checked>
          Movie <span class="checkmark"></span>
        </label>
        <label for="search-series">
          <input type="radio" name="search-type" value="tv" id="search-series">
          Series <span class="checkmark"></span>
        </label>
      </div>
      <button id="search-button">
        <span class="material-icons">search</span> Search
      </button>
    </div>
  </div>

  <main id="main-content">
    <div id="main-sections">
      <div class="trending-section" id="search-results-section" style="display: none;">
        <h2 id="search-results-heading"><span class="material-icons">search</span> Search Results</h2>
        <div class="results-grid" id="search-results"></div>
        <div class="see-more-container">
          <button id="see-more-search-results">
            <span class="material-icons">expand_more</span> See More Results
          </button>
        </div>
      </div>
      <div class="trending-section" id="trending-movies-section">
        <div class="sort-by">
          <label for="sort-movies">Sort Movies By:</label>
          <select id="sort-movies">
            <option value="trending">Trending</option>
            <option value="popular">Popular</option>
            <option value="top_rated">Top Rated</option>
            <option value="release_date">Release Date</option>
            <option value="vote_average">Rating</option>
          </select>
        </div>
        <h2 id="movies-heading"><span class="material-icons">local_fire_department</span> Trending Movies</h2>
        <div class="results-grid" id="trending-movies"></div>
        <div class="see-more-container">
          <button id="see-more-movies">
            <span class="material-icons">expand_more</span> See More Movies
          </button>
        </div>
      </div>
      <div class="trending-section" id="trending-series-section">
        <div class="sort-by">
          <label for="sort-series">Sort Series By:</label>
          <select id="sort-series">
            <option value="trending">Trending</option>
            <option value="popular">Popular</option>
            <option value="top_rated">Top Rated</option>
            <option value="release_date">Release Date</option>
            <option value="vote_average">Rating</option>
          </select>
        </div>
        <h2 id="series-heading"><span class="material-icons">tv</span> Trending Series</h2>
        <div class="results-grid" id="trending-series"></div>
        <div class="see-more-container">
          <button id="see-more-series">
            <span class="material-icons">expand_more</span> See More Series
          </button>
        </div>
      </div>
      <div class="trending-section" id="watchlist-section" style="display: none;">
        <h2 id="watchlist-heading"><span class="material-icons">bookmark</span> Watchlist</h2>
        <div class="results-grid" id="watchlist"></div>
      </div>
      <div class="trending-section" id="history-section" style="display: none;">
        <h2 id="history-heading"><span class="material-icons">history</span> History</h2>
        <div class="results-grid" id="history"></div>
      </div>
    </div>
    <div id="watchlist-items-section" style="display: none;">
      <button id="back-to-main-watchlist" class="back-button">
        <span class="material-icons">arrow_back</span> Back
      </button>
      <div class="trending-section">
        <h2><span class="material-icons">bookmark</span> Watchlist Items</h2>
        <div class="results-grid" id="watchlist-items"></div>
      </div>
    </div>
    <div id="history-items-section" style="display: none;">
      <button id="back-to-main-history" class="back-button">
        <span class="material-icons">arrow_back</span> Back
      </button>
      <div class="trending-section">
        <h2><span class="material-icons">history</span> History Items</h2>
        <div class="results-grid" id="history-items"></div>
      </div>
    </div>
    <div id="loading" class="spinner" style="display: none;"></div>
    <div id="embed-modal">
      <div id="embed-content">
        <span class="material-icons close-button">close</span>
        <div class="api-selector">
          <label for="api-select">Select Embed Provider:</label>
          <select id="api-select">
            <option value="sanu-flix-v2" selected>SanuFlix V2 Server</option>
            <option value="embed-su">SanuuFlix Server (Premium)</option>
            <option value="vidlink">Alternative server (Might contain ads)</option>
          </select>
        </div>
        <div class="selectors" id="season-episode-selectors">
          <select id="season-selector">
            <option value="">Select Season</option>
          </select>
          <select id="episode-selector" disabled>
            <option value="">Select Episode</option>
          </select>
        </div>
        <iframe src="" allow="fullscreen; autoplay"></iframe>
        <button id="share-button" class="share-button">
          <span class="material-icons">share</span> Share
        </button>
        <button id="trailer-button" class="trailer-button">
          <span class="material-icons">play_circle</span> Trailer
        </button>
        <button id="back-button" class="back-button" style="display: none;">
          <span class="material-icons">arrow_back</span> Back to Content
        </button>
        <button id="watched-button" class="watched-button">
          <span class="material-icons">check_circle</span> Already Watched
        </button>
      </div>
    </div>
  </main>
  <script>
    const searchToggle = document.getElementById('search-toggle');
    const searchBackdrop = document.getElementById('search-backdrop');
    const closeSearchBtn = document.querySelector('.close-search');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const searchMovieRadio = document.getElementById('search-movie');
    const searchSeriesRadio = document.getElementById('search-series');
    const sortMoviesSelect = document.getElementById('sort-movies');
    const sortSeriesSelect = document.getElementById('sort-series');
    const trendingMoviesDiv = document.getElementById('trending-movies');
    const trendingSeriesDiv = document.getElementById('trending-series');
    const seeMoreMoviesBtn = document.getElementById('see-more-movies');
    const seeMoreSeriesBtn = document.getElementById('see-more-series');
    const loadingSpinner = document.getElementById('loading');
    const embedModal = document.getElementById('embed-modal');
    const embedContent = document.getElementById('embed-content');
    const closeButton = document.querySelector('.close-button');
    const appTitle = document.getElementById('app-title');
    const moviesHeading = document.getElementById('movies-heading');
    const seriesHeading = document.getElementById('series-heading');
    const watchlistSection = document.getElementById('watchlist-section');
    const watchlistDiv = document.getElementById('watchlist');
    const historySection = document.getElementById('history-section');
    const historyDiv = document.getElementById('history');
    const searchResultsSection = document.getElementById('search-results-section');
    const searchResultsDiv = document.getElementById('search-results');
    const searchResultsHeading = document.getElementById('search-results-heading');
    const seeMoreSearchResultsBtn = document.getElementById('see-more-search-results');
    const apiSelect = document.getElementById('api-select');
    const embedIframe = embedContent.querySelector('iframe');
    const seasonEpisodeSelectors = document.getElementById('season-episode-selectors');
    const seasonSelector = document.getElementById('season-selector');
    const episodeSelector = document.getElementById('episode-selector');
    const shareButton = document.getElementById('share-button');
    const trailerButton = document.getElementById('trailer-button');
    const backButton = document.getElementById('back-button');
    const watchedButton = document.getElementById('watched-button');
    const header = document.querySelector('header');
    const mainContent = document.getElementById('main-content');
    const watchlistToggle = document.getElementById('watchlist-toggle');
    const historyToggle = document.getElementById('history-toggle');
    const mainSections = document.getElementById('main-sections');
    const watchlistItemsSection = document.getElementById('watchlist-items-section');
    const historyItemsSection = document.getElementById('history-items-section');
    const backToMainWatchlist = document.getElementById('back-to-main-watchlist');
    const backToMainHistory = document.getElementById('back-to-main-history');
    const watchlistItemsDiv = document.getElementById('watchlist-items');
    const historyItemsDiv = document.getElementById('history-items');
    const traktLoginButton = document.getElementById('trakt-login');

    // API Constants
    const API_KEY = '5e38ca50480518c0d1cde63718225f6c'; // TMDB API Key
    const TMDB_API_BASE_URL = 'https://api.themoviedb.org/3';
    const MAIN_SERVER_BASE_URL = 'https://embed.su/embed';
    const ALTERNATIVE_SERVER_BASE_URL = 'https://vidlink.pro';
    const TRAKT_API_BASE_URL = 'https://api.trakt.tv';
    const TRAKTClientId = 'eb2d86c63302fde62738f8e599453d0c0198fc82c8ff6d2b2a58e453a7bad85e';
    const TRAKTClientSecret = '25eb850f6cfab1d8a4dc5040e5be4e4ab2aed1e5644db5e3db2bc9eef8a1ed18';
    const TRAKTRedirectURI = 'https://sanuu7.github.io/Projects/Sanuflix.html';

    // State Variables
    let currentPageMovies = 1;
    let currentPageSeries = 1;
    let currentPageSearch = 1;
    let currentFilterMovies = 'trending';
    let currentFilterSeries = 'trending';
    let currentQuery = '';
    let currentSearchType = 'movie';
    let currentEmbedItem = null;
    let currentLanguage = localStorage.getItem('language') || 'en-US';
    let watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
    let history = JSON.parse(localStorage.getItem('history')) || [];
    let traktAccessToken = localStorage.getItem('traktAccessToken') || null;

    // Translations
    const translations = {
      'en-US': {
        appTitle: 'Sanuu Flix',
        searchPlaceholder: 'Search for movies or series...',
        searchButton: 'Search',
        movieLabel: 'Movie',
        seriesLabel: 'Series',
        sortByLabel: 'Sort By:',
        trendingOption: 'Trending',
        popularOption: 'Popular',
        topRatedOption: 'Top Rated',
        releaseDateOption: 'Release Date',
        ratingOption: 'Rating',
        searchResultsHeading: 'Search Results',
        trendingMoviesHeading: 'Trending Movies',
        popularMoviesHeading: 'Popular Movies',
        topRatedMoviesHeading: 'Top Rated Movies',
        releaseDateMoviesHeading: 'Movies by Release Date',
        voteAverageMoviesHeading: 'Movies by Rating',
        trendingSeriesHeading: 'Trending Series',
        popularSeriesHeading: 'Popular Series',
        topRatedSeriesHeading: 'Top Rated Series',
        releaseDateSeriesHeading: 'Series by Release Date',
        voteAverageSeriesHeading: 'Series by Rating',
        watchlistHeading: 'Watchlist',
        historyHeading: 'History',
        noResults: 'No results found.',
        errorFetching: 'Error fetching data.',
        seeMoreResults: 'See More Results',
        seeMoreMovies: 'See More Movies',
        seeMoreSeries: 'See More Series',
        embedProviderLabel: 'Select Embed Provider:',
        seasonPlaceholder: 'Select Season',
        episodePlaceholder: 'Select Episode',
        shareButton: 'Share',
        trailerButton: 'Trailer',
        backButton: 'Back to Content',
        watchedButton: 'Already Watched'
      },
      'de-DE': {
        appTitle: 'Sanuu Flix',
        searchPlaceholder: 'Suche nach Filmen oder Serien...',
        searchButton: 'Suchen',
        movieLabel: 'Film',
        seriesLabel: 'Serie',
        sortByLabel: 'Sortieren nach:',
        trendingOption: 'Trend',
        popularOption: 'Beliebt',
        topRatedOption: 'Am besten bewertet',
        releaseDateOption: 'Veröffentlichungsdatum',
        ratingOption: 'Bewertung',
        searchResultsHeading: 'Suchergebnisse',
        trendingMoviesHeading: 'Trendige Filme',
        popularMoviesHeading: 'Beliebte Filme',
        topRatedMoviesHeading: 'Am besten bewertete Filme',
        releaseDateMoviesHeading: 'Filme nach Veröffentlichungsdatum',
        voteAverageMoviesHeading: 'Filme nach Bewertung',
        trendingSeriesHeading: 'Trendige Serien',
        popularSeriesHeading: 'Beliebte Serien',
        topRatedSeriesHeading: 'Am besten bewertete Serien',
        releaseDateSeriesHeading: 'Serien nach Veröffentlichungsdatum',
        voteAverageSeriesHeading: 'Serien nach Bewertung',
        watchlistHeading: 'Merkliste',
        historyHeading: 'Zuletzt angesehen',
        noResults: 'Keine Ergebnisse gefunden.',
        errorFetching: 'Fehler beim Abrufen der Daten.',
        seeMoreResults: 'Mehr Ergebnisse anzeigen',
        seeMoreMovies: 'Mehr Filme anzeigen',
        seeMoreSeries: 'Mehr Serien anzeigen',
        embedProviderLabel: 'Wähle einen Anbieter:',
        seasonPlaceholder: 'Staffel auswählen',
        episodePlaceholder: 'Episode auswählen',
        shareButton: 'Teilen',
        trailerButton: 'Trailer',
        backButton: 'Zurück zum Inhalt',
        watchedButton: 'Bereits gesehen'
      }
    };

    // Search Functions
    async function openSearch() {
      searchBackdrop.style.display = 'block';
      setTimeout(() => { searchBackdrop.classList.add('show'); }, 10);
      header.classList.add('blur');
      mainContent.classList.add('blur');
      setTimeout(() => searchInput.focus(), 100);
    }

    function closeSearch() {
      searchBackdrop.classList.remove('show');
      setTimeout(() => {
        searchBackdrop.style.display = 'none';
        header.classList.remove('blur');
        mainContent.classList.remove('blur');
        searchInput.value = '';
      }, 300);
    }

    // Theme Toggle
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    });

    if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');

    // Language Selection
    const languageSelect = document.getElementById('language-select');
    languageSelect.value = currentLanguage;
    languageSelect.addEventListener('change', (e) => {
      currentLanguage = e.target.value;
      localStorage.setItem('language', currentLanguage);
      updateUI();
      resetSearch();
      loadTrending('movie', currentFilterMovies);
      loadTrending('tv', currentFilterSeries);
      displayWatchlist();
      displayHistory();
    });

    // Watchlist Management
    function toggleWatchlist(item) {
      const index = watchlist.findIndex(w => w.id === item.id && w.media_type === item.media_type);
      if (index === -1) {
        watchlist.push(item);
        if (traktAccessToken) syncToTrakt(item, 'watchlist');
      } else {
        watchlist.splice(index, 1);
        if (traktAccessToken) syncToTrakt(item, 'watchlist/remove');
      }
      localStorage.setItem('watchlist', JSON.stringify(watchlist));
      displayWatchlist();
      displayWatchlistItems();
    }

    async function syncToTrakt(item, endpoint) {
      if (!traktAccessToken) return;
      const url = `${TRAKT_API_BASE_URL}/sync/${endpoint}`;
      const body = {
        [item.media_type === 'movie' ? 'movies' : 'shows']: [{
          ids: { tmdb: item.id }
        }]
      };
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${traktAccessToken}`,
            'trakt-api-version': '2',
            'trakt-api-key': TRAKTClientId
          },
          body: JSON.stringify(body)
        });
        if (!response.ok) throw new Error('Trakt sync failed');
        if (endpoint === 'watchlist') syncWatchlistFromTrakt();
      } catch (error) {
        console.error('Trakt sync error:', error);
      }
    }

    async function syncWatchlistFromTrakt() {
      if (!traktAccessToken) return;
      try {
        const movieResponse = await fetch(`${TRAKT_API_BASE_URL}/sync/watchlist/movies`, {
          headers: {
            'Authorization': `Bearer ${traktAccessToken}`,
            'trakt-api-version': '2',
            'trakt-api-key': TRAKTClientId
          }
        });
        const showResponse = await fetch(`${TRAKT_API_BASE_URL}/sync/watchlist/shows`, {
          headers: {
            'Authorization': `Bearer ${traktAccessToken}`,
            'trakt-api-version': '2',
            'trakt-api-key': TRAKTClientId
          }
        });
        if (!movieResponse.ok || !showResponse.ok) throw new Error('Trakt fetch failed');
        const movies = await movieResponse.json();
        const shows = await showResponse.json();
        watchlist = [
          ...movies.map(item => ({
            id: item.movie.ids.tmdb,
            title: item.movie.title,
            media_type: 'movie',
            poster_path: null
          })),
          ...shows.map(item => ({
            id: item.show.ids.tmdb,
            title: item.show.title,
            media_type: 'tv',
            poster_path: null
          }))
        ];
        localStorage.setItem('watchlist', JSON.stringify(watchlist));
        await Promise.all(watchlist.map(async item => {
          const response = await fetch(`${TMDB_API_BASE_URL}/${item.media_type}/${item.id}?api_key=${API_KEY}`);
          const data = await response.json();
          item.poster_path = data.poster_path;
        }));
        localStorage.setItem('watchlist', JSON.stringify(watchlist));
        displayWatchlist();
        displayWatchlistItems();
      } catch (error) {
        console.error('Trakt sync error:', error);
      }
    }

    function displayWatchlist() {
      watchlistDiv.innerHTML = '';
      if (watchlist.length > 0) {
        watchlistSection.style.display = 'block';
        watchlist.forEach(item => {
          const card = createCard(item, item.media_type);
          watchlistDiv.appendChild(card);
        });
      } else { watchlistSection.style.display = 'none'; }
    }

    function displayWatchlistItems() {
      watchlistItemsDiv.innerHTML = '';
      if (watchlist.length > 0) {
        watchlist.forEach(item => {
          const card = createCard(item, item.media_type);
          watchlistItemsDiv.appendChild(card);
        });
      }
    }

    // History Management
    function addToHistory(item) {
      history = history.filter(i => i.id !== item.id || i.media_type !== item.media_type);
      history.unshift(item);
      history = history.slice(0, 5);
      localStorage.setItem('history', JSON.stringify(history));
      if (traktAccessToken) syncWatchedToTrakt(item);
      displayHistory();
      displayHistoryItems();
    }

    async function syncWatchedToTrakt(item) {
      if (!traktAccessToken) return;
      const url = `${TRAKT_API_BASE_URL}/sync/history`;
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${traktAccessToken}`,
            'trakt-api-version': '2',
            'trakt-api-key': TRAKTClientId
          },
          body: JSON.stringify({
            [item.media_type === 'movie' ? 'movies' : 'shows']: [{
              ids: { tmdb: item.id }
            }]
          })
        });
        if (!response.ok) throw new Error('Trakt watched sync failed');
      } catch (error) {
        console.error('Trakt watched sync error:', error);
      }
    }

    function displayHistory() {
      historyDiv.innerHTML = '';
      if (history.length > 0) {
        historySection.style.display = 'block';
        history.forEach(item => {
          const card = createCard(item, item.media_type);
          historyDiv.appendChild(card);
        });
      } else { historySection.style.display = 'none'; }
    }

    function displayHistoryItems() {
      historyItemsDiv.innerHTML = '';
      if (history.length > 0) {
        history.forEach(item => {
          const card = createCard(item, item.media_type);
          historyItemsDiv.appendChild(card);
        });
      }
    }

    // Utility Functions
    function showLoading(show) {
      loadingSpinner.style.display = show ? 'block' : 'none';
    }

    function createCard(item, type) {
      const card = document.createElement('div');
      card.classList.add('card');
      const img = document.createElement('img');
      img.src = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/500x750?text=No+Image';
      img.alt = item.title || item.name;
      const cardContent = document.createElement('div');
      cardContent.classList.add('card-content');
      const title = document.createElement('h3');
      title.textContent = item.title || item.name;
      const date = document.createElement('p');
      const releaseDate = item.release_date || item.first_air_date || 'N/A';
      date.textContent = (type === 'movie' ? 'Release: ' : 'First Air: ') + releaseDate;
      const watchlistBtn = document.createElement('button');
      watchlistBtn.classList.add('watchlist-btn');
      watchlistBtn.innerHTML = '<span class="material-icons">bookmark</span>';
      watchlistBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleWatchlist({ ...item, media_type: type });
      });
      cardContent.appendChild(watchlistBtn);
      cardContent.appendChild(title);
      cardContent.appendChild(date);
      card.appendChild(img);
      card.appendChild(cardContent);
      const tooltip = document.createElement('div');
      tooltip.classList.add('card-tooltip');
      tooltip.innerHTML = `<p class="rating">⭐ ${item.vote_average || 'N/A'}</p>
                           <p>${item.overview ? item.overview.substring(0, 100) + '...' : 'No overview available.'}</p>`;
      card.appendChild(tooltip);
      card.addEventListener('click', () => openEmbedModal(item, type));
      return card;
    }

    function updateUI() {
      const t = translations[currentLanguage];
      appTitle.innerHTML = `<span class="material-icons">movie</span> ${t.appTitle}`;
      searchInput.placeholder = t.searchPlaceholder;
      searchButton.innerHTML = `<span class="material-icons">search</span> ${t.searchButton}`;
      document.querySelector('label[for="search-movie"]').childNodes[0].textContent = t.movieLabel;
      document.querySelector('label[for="search-series"]').childNodes[0].textContent = t.seriesLabel;
      searchResultsHeading.innerHTML = `<span class="material-icons">search</span> ${t.searchResultsHeading}`;
      if (currentFilterMovies === 'trending')
        moviesHeading.innerHTML = `<span class="material-icons">local_fire_department</span> ${t.trendingMoviesHeading}`;
      else if (currentFilterMovies === 'popular')
        moviesHeading.innerHTML = `<span class="material-icons">local_fire_department</span> ${t.popularMoviesHeading}`;
      else if (currentFilterMovies === 'top_rated')
        moviesHeading.innerHTML = `<span class="material-icons">local_fire_department</span> ${t.topRatedMoviesHeading}`;
      else if (currentFilterMovies === 'release_date')
        moviesHeading.innerHTML = `<span class="material-icons">local_fire_department</span> ${t.releaseDateMoviesHeading}`;
      else if (currentFilterMovies === 'vote_average')
        moviesHeading.innerHTML = `<span class="material-icons">local_fire_department</span> ${t.voteAverageMoviesHeading}`;
      if (currentFilterSeries === 'trending')
        seriesHeading.innerHTML = `<span class="material-icons">tv</span> ${t.trendingSeriesHeading}`;
      else if (currentFilterSeries === 'popular')
        seriesHeading.innerHTML = `<span class="material-icons">tv</span> ${t.popularSeriesHeading}`;
      else if (currentFilterSeries === 'top_rated')
        seriesHeading.innerHTML = `<span class="material-icons">tv</span> ${t.topRatedSeriesHeading}`;
      else if (currentFilterSeries === 'release_date')
        seriesHeading.innerHTML = `<span class="material-icons">tv</span> ${t.releaseDateSeriesHeading}`;
      else if (currentFilterSeries === 'vote_average')
        seriesHeading.innerHTML = `<span class="material-icons">tv</span> ${t.voteAverageSeriesHeading}`;
      document.getElementById('watchlist-heading').innerHTML = `<span class="material-icons">bookmark</span> ${t.watchlistHeading}`;
      document.getElementById('history-heading').innerHTML = `<span class="material-icons">history</span> ${t.historyHeading}`;
      sortMoviesSelect.options[0].text = t.trendingOption;
      sortMoviesSelect.options[1].text = t.popularOption;
      sortMoviesSelect.options[2].text = t.topRatedOption;
      sortMoviesSelect.options[3].text = t.releaseDateOption;
      sortMoviesSelect.options[4].text = t.ratingOption;
      sortSeriesSelect.options[0].text = t.trendingOption;
      sortSeriesSelect.options[1].text = t.popularOption;
      sortSeriesSelect.options[2].text = t.topRatedOption;
      sortSeriesSelect.options[3].text = t.releaseDateOption;
      sortSeriesSelect.options[4].text = t.ratingOption;
      seeMoreSearchResultsBtn.innerHTML = `<span class="material-icons">expand_more</span> ${t.seeMoreResults}`;
      seeMoreMoviesBtn.innerHTML = `<span class="material-icons">expand_more</span> ${t.seeMoreMovies}`;
      seeMoreSeriesBtn.innerHTML = `<span class="material-icons">expand_more</span> ${t.seeMoreSeries}`;
      document.querySelector('.api-selector label').textContent = t.embedProviderLabel;
      seasonSelector.options[0].text = t.seasonPlaceholder;
      episodeSelector.options[0].text = t.episodePlaceholder;
      shareButton.innerHTML = `<span class="material-icons">share</span> ${t.shareButton}`;
      trailerButton.innerHTML = `<span class="material-icons">play_circle</span> ${t.trailerButton}`;
      backButton.innerHTML = `<span class="material-icons">arrow_back</span> ${t.backButton}`;
      watchedButton.innerHTML = `<span class="material-icons">check_circle</span> ${t.watchedButton}`;
    }

    // Content Loading
    async function loadTrending(type, sortFilter, page = 1) {
      showLoading(true);
      let endpoint;
      if (sortFilter === 'trending') {
        endpoint = `${TMDB_API_BASE_URL}/trending/${type}/day?api_key=${API_KEY}&page=${page}&language=${currentLanguage}`;
      } else {
        endpoint = `${TMDB_API_BASE_URL}/${type}/${
          sortFilter === 'popular' ? 'popular' : 
          sortFilter === 'top_rated' ? 'top_rated' : 
          'popular'
        }?api_key=${API_KEY}&language=${currentLanguage}&page=${page}`;
      }
      try {
        const response = await fetch(endpoint);
        if (!response.ok) throw new Error('Failed to fetch trending data.');
        const data = await response.json();
        let items = data.results;
        if (sortFilter === 'release_date') {
          items.sort((a, b) => new Date(b.release_date || b.first_air_date) - new Date(a.release_date || a.first_air_date));
        } else if (sortFilter === 'vote_average') {
          items.sort((a, b) => (b.vote_average || 0) - (a.vote_average || 0));
        }
        const container = type === 'movie' ? trendingMoviesDiv : trendingSeriesDiv;
        if (page === 1) container.innerHTML = '';
        displayItems(items, type, container);
        if (type === 'movie') currentPageMovies = page;
        else currentPageSeries = page;
      } catch (error) {
        console.error('Error:', error);
        alert(translations[currentLanguage].errorFetching);
      } finally {
        showLoading(false);
      }
    }

    async function searchContent(query, type, page = 1) {
      showLoading(true);
      const endpoint = `${TMDB_API_BASE_URL}/search/${type}?api_key=${API_KEY}&query=${encodeURIComponent(query)}&page=${page}&language=${currentLanguage}`;
      try {
        const response = await fetch(endpoint);
        if (!response.ok) throw new Error('Failed to fetch search results.');
        const data = await response.json();
        if (type === 'movie') {
          data.results.sort((a, b) => b.popularity - a.popularity);
        }
        searchResultsSection.style.display = 'block';
        mainSections.querySelector('#trending-movies-section').style.display = 'none';
        mainSections.querySelector('#trending-series-section').style.display = 'none';
        if (page === 1) searchResultsDiv.innerHTML = '';
        if (data.results.length === 0) {
          if (page === 1) {
            searchResultsDiv.innerHTML = `<p>${translations[currentLanguage].noResults}</p>`;
            searchResultsHeading.innerHTML = `<span class="material-icons">search</span> ${translations[currentLanguage].searchResultsHeading} for "${query}"`;
          }
        } else {
          displayItems(data.results, type, searchResultsDiv);
          searchResultsHeading.innerHTML = `<span class="material-icons">search</span> ${translations[currentLanguage].searchResultsHeading} for "${query}"`;
        }
        currentPageSearch = page;
        seeMoreSearchResultsBtn.style.display = data.total_pages > page ? 'block' : 'none';
      } catch (error) {
        console.error('Error:', error);
        searchResultsDiv.innerHTML = `<p style="color: var(--error-color);">${translations[currentLanguage].errorFetching}</p>`;
      } finally {
        showLoading(false);
      }
    }

    function displayItems(items, type, container) {
      items.forEach(item => {
        const card = createCard(item, type);
        container.appendChild(card);
      });
    }

    // Embed Modal Functions
    async function fetchSeasons(item) {
      if (currentSearchType !== 'tv' || !item) return;
      try {
        const response = await fetch(`${TMDB_API_BASE_URL}/tv/${item.id}?api_key=${API_KEY}&language=${currentLanguage}`);
        if (!response.ok) throw new Error('Failed to fetch TV details.');
        const data = await response.json();
        const seasons = data.seasons.filter(season => season.season_number !== 0);
        seasonSelector.innerHTML = `<option value="">${translations[currentLanguage].seasonPlaceholder}</option>`;
        seasons.forEach(season => {
          const option = document.createElement('option');
          option.value = season.season_number;
          option.textContent = `Season ${season.season_number}`;
          seasonSelector.appendChild(option);
        });
        seasonEpisodeSelectors.style.display = 'flex';
      } catch (error) { console.error('Error fetching seasons:', error); }
    }

    async function fetchEpisodes(seasonNumber) {
      try {
        const response = await fetch(`${TMDB_API_BASE_URL}/tv/${currentEmbedItem.id}/season/${seasonNumber}?api_key=${API_KEY}&language=${currentLanguage}`);
        if (!response.ok) throw new Error('Failed to fetch episodes.');
        const data = await response.json();
        episodeSelector.innerHTML = `<option value="">${translations[currentLanguage].episodePlaceholder}</option>`;
        data.episodes.forEach(episode => {
          const option = document.createElement('option');
          option.value = episode.episode_number;
          option.textContent = `Episode ${episode.episode_number}: ${episode.name}`;
          episodeSelector.appendChild(option);
        });
        episodeSelector.disabled = false;
      } catch (error) { console.error('Error fetching episodes:', error); }
    }

    async function generateEmbedURL() {
      if (!currentEmbedItem) return null;
      const selectedProvider = apiSelect.value;
      if (selectedProvider === 'sanu-flix-v2') {
        if (currentSearchType === 'movie') {
          return `https://player.videasy.net/movie/${currentEmbedItem.id}`;
        } else if (currentSearchType === 'tv') {
          const season = seasonSelector.value || 1;
          const episode = episodeSelector.value || 1;
          return `https://player.videasy.net/tv/${currentEmbedItem.id}/${season}/${episode}`;
        }
      } else if (selectedProvider === 'embed-su') {
        let embedURL = `${MAIN_SERVER_BASE_URL}/${currentSearchType}/${currentEmbedItem.id}`;
        if (currentSearchType === 'tv') {
          const season = seasonSelector.value || 1;
          const episode = episodeSelector.value || 1;
          embedURL += `/${season}/${episode}`;
        }
        return embedURL;
      } else if (selectedProvider === 'vidlink') {
        if (currentSearchType === 'movie') {
          return `${ALTERNATIVE_SERVER_BASE_URL}/movie/${currentEmbedItem.id}`;
        } else if (currentSearchType === 'tv') {
          const season = seasonSelector.value;
          const episode = episodeSelector.value;
          if (!season || !episode) return null;
          return `${ALTERNATIVE_SERVER_BASE_URL}/tv/${currentEmbedItem.id}/${season}/${episode}`;
        }
      }
      return null;
    }

    async function loadEmbedVideo() {
      const embedURL = await generateEmbedURL();
      if (embedURL) embedIframe.src = embedURL;
    }

    async function loadTrailer() {
      try {
        const endpoint = `${TMDB_API_BASE_URL}/${currentSearchType}/${currentEmbedItem.id}/videos?api_key=${API_KEY}&language=${currentLanguage}`;
        const response = await fetch(endpoint);
        if (!response.ok) throw new Error('Failed to fetch trailer.');
        const data = await response.json();
        const trailer = data.results.find(v => v.type === 'Trailer' && v.site === 'YouTube');
        if (trailer) {
          embedIframe.src = `https://www.youtube.com/embed/${trailer.key}`;
          backButton.style.display = 'block';
        } else { alert('No trailer available.'); }
      } catch (error) { console.error('Error fetching trailer:', error); }
    }

    // Trakt Integration
    async function handleTraktLogin() {
      if (traktAccessToken) {
        alert('Already logged into Trakt');
        return;
      }
      const authUrl = `https://trakt.tv/authorize?response_type=code&client_id=${TRAKTClientId}&redirect%20URI=${encodeURIComponent(TRAKTRedirectURI)}&scope=private&state=xyz`;
      window.location.href = authUrl;
    }

    async function handleTraktCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        try {
          const response = await fetch('https://api.trakt.tv/oauth/token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
              code,
              client_id: TRAKTClientId,
              client_secret: TRAKTClientSecret,
              redirect_uri: TRAKTRedirectURI,
              grant_type: 'authorization_code'
            }).toString()
          });
          if (!response.ok) throw new Error('Trakt auth failed');
          const data = await response.json();
          traktAccessToken = data.access_token;
          localStorage.setItem('traktAccessToken', traktAccessToken);
          window.history.replaceState({}, document.title, TRAKTRedirectURI);
          syncWatchlistFromTrakt();
        } catch (error) {
          console.error('Trakt authentication error:', error);
          alert('Trakt authentication failed. Please try again.');
        }
      }
    }

    // Event Listeners
    watchedButton.addEventListener('click', () => {
      if (currentEmbedItem) {
        addToHistory({ ...currentEmbedItem, media_type: currentSearchType });
        alert('Marked as watched on Trakt and History');
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadTrending('movie', currentFilterMovies);
      loadTrending('tv', currentFilterSeries);
      displayWatchlist();
      displayHistory();
      updateUI();
      handleTraktCallback();
    });

    searchToggle.addEventListener('click', openSearch);
    closeSearchBtn.addEventListener('click', closeSearch);
    searchBackdrop.addEventListener('click', (e) => { if (e.target === searchBackdrop) closeSearch(); });
    searchButton.addEventListener('click', () => {
      const query = searchInput.value.trim();
      if (query === '') return;
      currentQuery = query;
      currentSearchType = searchMovieRadio.checked ? 'movie' : 'tv';
      currentPageSearch = 1;
      searchContent(query, currentSearchType, currentPageSearch);
      closeSearch();
    });
    searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchButton.click(); });
    sortMoviesSelect.addEventListener('change', () => {
      currentFilterMovies = sortMoviesSelect.value;
      currentPageMovies = 1;
      trendingMoviesDiv.innerHTML = '';
      loadTrending('movie', currentFilterMovies);
      updateUI();
    });
    sortSeriesSelect.addEventListener('change', () => {
      currentFilterSeries = sortSeriesSelect.value;
      currentPageSeries = 1;
      trendingSeriesDiv.innerHTML = '';
      loadTrending('tv', currentFilterSeries);
      updateUI();
    });
    seeMoreMoviesBtn.addEventListener('click', () => { currentPageMovies++; loadTrending('movie', currentFilterMovies, currentPageMovies); });
    seeMoreSeriesBtn.addEventListener('click', () => { currentPageSeries++; loadTrending('tv', currentFilterSeries, currentPageSeries); });
    seeMoreSearchResultsBtn.addEventListener('click', () => { currentPageSearch++; searchContent(currentQuery, currentSearchType, currentPageSearch); });
    closeButton.addEventListener('click', () => { embedModal.style.display = 'none'; embedIframe.src = ''; backButton.style.display = 'none'; });
    window.addEventListener('click', (e) => { if (e.target === embedModal) { embedModal.style.display = 'none'; embedIframe.src = ''; backButton.style.display = 'none'; } });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && embedModal.style.display === 'flex') { embedModal.style.display = 'none'; embedIframe.src = ''; backButton.style.display = 'none'; } });
    appTitle.addEventListener('click', resetSearch);
    apiSelect.addEventListener('change', loadEmbedVideo);
    seasonSelector.addEventListener('change', () => { if (seasonSelector.value) fetchEpisodes(seasonSelector.value); loadEmbedVideo(); });
    episodeSelector.addEventListener('change', loadEmbedVideo);
    shareButton.addEventListener('click', () => {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({ title: currentEmbedItem.title || currentEmbedItem.name, url: url }).catch(console.error);
      } else { navigator.clipboard.writeText(url).then(() => alert('Link copied to clipboard!')); }
    });
    trailerButton.addEventListener('click', loadTrailer);
    backButton.addEventListener('click', () => { loadEmbedVideo(); backButton.style.display = 'none'; });
    watchlistToggle.addEventListener('click', () => {
      mainSections.style.display = 'none';
      watchlistItemsSection.style.display = 'block';
      historyItemsSection.style.display = 'none';
      displayWatchlistItems();
    });
    historyToggle.addEventListener('click', () => {
      mainSections.style.display = 'none';
      historyItemsSection.style.display = 'block';
      watchlistItemsSection.style.display = 'none';
      displayHistoryItems();
    });
    backToMainWatchlist.addEventListener('click', () => { watchlistItemsSection.style.display = 'none'; mainSections.style.display = 'block'; resetSearch(); });
    backToMainHistory.addEventListener('click', () => { historyItemsSection.style.display = 'none'; mainSections.style.display = 'block'; resetSearch(); });
    traktLoginButton.addEventListener('click', handleTraktLogin);

    // Modal and Reset Functions
    function openEmbedModal(item, type) {
      currentEmbedItem = item;
      currentSearchType = type;
      embedModal.style.display = 'flex';
      embedIframe.src = '';
      backButton.style.display = 'none';
      apiSelect.value = 'sanu-flix-v2';
      seasonEpisodeSelectors.style.display = type === 'tv' ? 'flex' : 'none';
      if (type === 'tv') fetchSeasons(item);
      addToHistory({ ...item, media_type: type });
      loadEmbedVideo();
    }

    function resetSearch() {
      currentQuery = '';
      searchInput.value = '';
      searchResultsDiv.innerHTML = '';
      searchResultsSection.style.display = 'none';
      mainSections.querySelector('#trending-movies-section').style.display = 'block';
      mainSections.querySelector('#trending-series-section').style.display = 'block';
      trendingMoviesDiv.innerHTML = '';
      trendingSeriesDiv.innerHTML = '';
      currentPageMovies = 1;
      currentPageSeries = 1;
      loadTrending('movie', currentFilterMovies);
      loadTrending('tv', currentFilterSeries);
      updateUI();
    }

    updateUI();
  </script>
</body>
</html>
